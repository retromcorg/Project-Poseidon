name: Release Workflow

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "8"
          cache: maven

      - name: Get Maven project version
        id: get_version
        run: echo "PROJECT_VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)" >> "$GITHUB_ENV"

      - name: Fail if snapshot version
        run: |
          if [[ "$PROJECT_VERSION" == *"-SNAPSHOT"* ]]; then
            echo "Snapshot versions are not releasable: $PROJECT_VERSION"
            exit 1
          fi

      - name: Generate Release Version
        run: |
          DATE=$(date +'%y%m%d-%H%M')
          SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          RELEASE_VERSION="${PROJECT_VERSION}-${DATE}-${SHA}"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> "$GITHUB_ENV"
          echo "Release version: $RELEASE_VERSION"

      - name: Set Maven version to Release Version (no commit)
        run: |
          mvn -B versions:set -DnewVersion="${RELEASE_VERSION}" -DgenerateBackupPoms=false

      - name: Create version.properties
        run: |
          mkdir -p src/main/resources

          APP_NAME=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.name)

          {
            echo "version=${RELEASE_VERSION}"
            echo "build_timestamp=$(date --utc +'%Y-%m-%dT%H:%M:%SZ')"
            echo "git_branch=${GITHUB_REF_NAME}"
            echo "git_commit=${GITHUB_SHA}"
            echo "app_name=${APP_NAME}"
            echo "release_version=${RELEASE_VERSION}"
            echo "maven_version=${RELEASE_VERSION}"

            if [[ "$GITHUB_REF" == "refs/heads/master" || "$GITHUB_REF" == "refs/heads/main" ]]; then
              BUILD_TYPE="production"
            else
              BUILD_TYPE="development"
            fi
            echo "build_type=${BUILD_TYPE}"

            echo "workflow_name=${GITHUB_WORKFLOW}"
            echo "workflow_run_id=${GITHUB_RUN_ID}"
            echo "workflow_run_number=${GITHUB_RUN_NUMBER}"
            echo "build_author=${GITHUB_ACTOR}"
          } > src/main/resources/version.properties

      - name: Write Maven settings.xml for Nexus auth
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>johnymuffin-nexus</id>
                <username>${env.NEXUS_USERNAME}</username>
                <password>${env.NEXUS_PASSWORD}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

      - name: Build & Deploy to Nexus
        run: mvn -B -DskipTests clean deploy
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: ${{ env.RELEASE_VERSION }}
          files: |
            target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}